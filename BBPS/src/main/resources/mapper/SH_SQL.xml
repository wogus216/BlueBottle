<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SH">
	
<select id="getOCnt" parameterType="hashmap" resultType="Integer">
	SELECT COUNT(*) AS CNT
	FROM ORD
	WHERE DEL_FLAG!=0
		<if test="search_input != null and search_input != ''">
			<choose>
				<when test="search_filter == 0">
					AND ORD_NO LIKE '%' || #{search_input} || '%'
				</when>
			</choose>
		</if>
</select>

<select id ="getOList" parameterType="hashmap" resultType="hashmap">
	SELECT *
	FROM(SELECT ORD_NO, TO_CHAR(ENROLL_DATE, 'YYYY-MM-DD')AS ENROLL_DATE,
	BRCH_NAME, CODE_S_CATE, CODE_NAME, TO_CHAR(PROCESS_DATE, 'YYYY-MM-DD')AS PROCESS_DATE, 
	ROW_NUMBER() OVER(ORDER BY ORD_NO DESC)AS RNUM
		 FROM COMMON_CODE C INNER JOIN ORD O
                               		ON C.CODE_S_CATE=O.STAT_CODE
                       		INNER JOIN BRCH B
                               		ON B.BRCH_NO = O.BRCH_NO
         WHERE  C.CODE_L_CATE=2 AND O.DEL_FLAG != 0
	<if test="search_input != null and search_input != ''">
		<choose>
			<when test="search_filter == 0">
				AND ORD_NO LIKE '%' || #{search_input} || '%'
			</when>
		</choose>
	</if>
		)ORD
	WHERE ORD.RNUM BETWEEN #{startCnt} AND #{endCnt}
</select>
<select id="getODtlList" parameterType="hashmap" resultType="hashmap">
SELECT *
FROM(SELECT O.ORD_NO, OI.ITEM_NO, I.ITEM_NAME, OI.CNT, OI.PRICE, TO_CHAR(EXPIRY_DATE, 'YYYY-MM-DD')AS EXPIRY_DATE
     FROM ORD O INNER JOIN ORD_ITEM OI
                      	ON O.ORD_NO = OI.ORD_NO
                INNER JOIN ITEM I
                        ON OI.ITEM_NO=I.ITEM_NO)ORD
WHERE ORD.ORD_NO= #{oNo}
</select>
<select id="getODtl" parameterType="hashmap" resultType="hashmap">
SELECT *
FROM(SELECT O.ORD_NO, TO_CHAR(ENROLL_DATE, 'YYYY-MM-DD')AS ENROLL_DATE, BRCH_NAME, TO_CHAR(PROCESS_DATE, 'YYYY-MM-DD')AS PROCESS_DATE, CODE_NAME, NON_APV_RSN
     FROM ORD O INNER JOIN ORD_ITEM OI
                      	ON O.ORD_NO = OI.ORD_NO
                INNER JOIN BRCH B
                        ON B.BRCH_NO = O.BRCH_NO
                INNER JOIN COMMON_CODE C
                        ON C.CODE_S_CATE=O.STAT_CODE
     WHERE C.CODE_L_CATE=2)ORD
WHERE ORD.ORD_NO= #{oNo}
GROUP BY ORD_NO, ENROLL_DATE, BRCH_NAME, PROCESS_DATE, CODE_NAME, NON_APV_RSN
</select>

<select id="getRDtlList" parameterType="hashmap" resultType="hashmap">
SELECT *
FROM(SELECT O.ORD_NO, OI.ITEM_NO, I.ITEM_NAME, OI.CNT, OI.PRICE,
RI.CNT AS RCNT, RSN
	 FROM ORD O INNER JOIN REF R
                        ON O.ORD_NO=R.ORD_NO
                INNER JOIN REF_ITEM RI
                        ON R.REF_NO=RI.REF_NO
                INNER JOIN ITEM I
                        ON RI.ITEM_NO = I.ITEM_NO
                INNER JOIN ORD_ITEM OI
                        ON RI.ITEM_NO = OI.ITEM_NO)REF
WHERE REF.ORD_NO= #{oNo}
</select>

<select id="getRDtl" parameterType="hashmap" resultType="hashmap">
SELECT *
FROM(SELECT O.ORD_NO, REF_NO, TO_CHAR(R.ENROLL_DATE, 'YYYY-MM-DD')AS ENROLL_DATE, CODE_NAME, TO_CHAR(R.PROCESS_DATE, 'YYYY-MM-DD')AS PROCESS_DATE, R.NON_APV_RSN
     FROM ORD O INNER JOIN REF R
                  		ON O.ORD_NO=R.ORD_NO
                INNER JOIN COMMON_CODE C
                        ON C.CODE_S_CATE=O.STAT_CODE
     WHERE C.CODE_L_CATE=2)REF
WHERE REF.ORD_NO= #{oNo}
</select>
</mapper> 
